<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>{{{ PRODUCT_NAME }}} - Kulino</title>
  <link rel="shortcut icon" href="TemplateData/favicon.ico" />
  <link rel="stylesheet" href="TemplateData/style.css" />

  <!-- Mobile Viewport -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-fullscreen" />

  <style>
  /* ===== RESET ===== */
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  html, body {
    width: 100%;
    height: 100%;
    overflow: hidden;
    position: fixed;
    background: #000;
  }

  /* ===== Unity Container ===== */
  #unity-container {
    width: 100%;
    height: 100%;
    position: absolute;
    top: 0;
    left: 0;
  }

  #unity-canvas {
    display: block !important;
    width: 100% !important;
    height: 100% !important;
    position: absolute;
    top: 0;
    left: 0;
    background: #000;
  }

  /* ===== Rotation Prompt ===== */
  #rotation-prompt {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.98);
    z-index: 99999;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 20px;
  }
  
  #rotation-prompt.show {
    display: flex !important;
  }
  
  .rotation-icon {
    font-size: 100px;
    margin-bottom: 30px;
    animation: rotate-pulse 2s ease-in-out infinite;
  }
  
  @keyframes rotate-pulse {
    0%, 100% { transform: rotate(0deg) scale(1); }
    25% { transform: rotate(-15deg) scale(1.1); }
    50% { transform: rotate(90deg) scale(1.2); }
    75% { transform: rotate(105deg) scale(1.1); }
  }
  
  .rotation-text {
    font-size: 28px;
    font-weight: bold;
    color: #fff;
    margin-bottom: 15px;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
  }
  
  .rotation-subtext {
    font-size: 18px;
    color: #aaa;
    margin-bottom: 30px;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
  }

  .skip-button {
    padding: 12px 32px;
    background: rgba(255,255,255,0.1);
    border: 2px solid rgba(255,255,255,0.3);
    color: #fff;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    font-family: -apple-system, sans-serif;
    transition: all 0.3s;
  }

  .skip-button:hover {
    background: rgba(255,255,255,0.2);
    border-color: rgba(255,255,255,0.5);
  }

  #unity-loading-bar {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 1000;
  }
  </style>

  <!-- Required Libraries -->
  <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
  <script src="https://unpkg.com/@solana/spl-token@latest/lib/index.iife.min.js"></script>
  <script src="https://unpkg.com/bs58@4.0.1/dist/index.min.js"></script>
  <script src="https://unpkg.com/buffer-layout@1.2.2/lib/layout-browser.js"></script>
  <script src="phantom-payment.js"></script>
</head>

<body>
  <!-- ‚úÖ ROTATION PROMPT (with skip button) -->
  <div id="rotation-prompt">
    <div class="rotation-icon">üì±‚û°Ô∏èüîÑ</div>
    <div class="rotation-text">Please Rotate Your Device</div>
    <div class="rotation-subtext">This game works best in landscape mode</div>
    <button class="skip-button" onclick="window.skipRotationPrompt()">
      Skip and Continue ‚Üí
    </button>
  </div>

  <!-- Unity Container -->
  <div id="unity-container">
    <canvas id="unity-canvas" tabindex="-1"></canvas>
    <div id="unity-loading-bar" style="display:none">
      <div id="unity-logo"></div>
      <div id="unity-progress-bar-empty">
        <div id="unity-progress-bar-full"></div>
      </div>
    </div>
    <div id="unity-warning"></div>
  </div>

  <!-- Error Handler -->
  <script>
    window.onerror = function (message, source, lineno, colno, error) {
      var suppressedErrors = ['Module_main', 'callMain', 'doRun', 'ExitStatus'];
      var shouldSuppress = suppressedErrors.some(function (err) {
        return message.includes(err);
      });
      if (shouldSuppress) return true;
      return false;
    };

    function unityShowBanner(msg, type) {
      try {
        var warningBanner = document.querySelector("#unity-warning");
        function updateBannerVisibility() {
          warningBanner.style.display = warningBanner.children.length ? "block" : "none";
        }
        var div = document.createElement("div");
        div.textContent = msg;
        div.style.padding = "8px";
        div.style.margin = "6px";
        if (type === "error") div.style.background = "rgba(200,0,0,0.9)";
        else if (type === "warning") div.style.background = "rgba(200,160,0,0.9)";
        else div.style.background = "rgba(0,0,0,0.6)";
        warningBanner.appendChild(div);
        if (type !== "error") {
          setTimeout(function () {
            warningBanner.removeChild(div);
            updateBannerVisibility();
          }, 5000);
        }
        updateBannerVisibility();
      } catch (e) {
        console.warn('unityShowBanner error', e);
      }
    }
  </script>

  <!-- ‚úÖ ULTRA-FIXED v5.0: Aggressive Orientation Detection -->
  <script>
  (function() {
    'use strict';
    
    console.log('%c[ORIENT] v5.0 - AGGRESSIVE DETECTION', 'color: #0f0; font-weight: bold');

    // ===== CONFIG =====
    const CONFIG = {
      MOBILE_MAX_WIDTH: 900,
      PORTRAIT_THRESHOLD: 1.1,
      CHECK_DELAY: 100,              // ‚úÖ Faster (was 300ms)
      CONTINUOUS_CHECK_INTERVAL: 250, // ‚úÖ Poll every 250ms when portrait
      DIMENSION_STABILIZE_TIME: 200   // ‚úÖ Wait for dimensions to settle
    };

    let state = {
      mobile: false,
      portrait: false,
      promptVisible: false,
      lastCheck: 0,
      checkCount: 0
    };

    let continuousCheckTimer = null;
    let dimensionCheckTimer = null;

    // ===== MOBILE DETECTION =====
    window.IsMobileBrowser = function() {
      const ua = navigator.userAgent || '';
      const width = window.innerWidth;
      
      const isMobileUA = /Android.*Mobile|iPhone|iPod|BlackBerry|IEMobile|Opera Mini/i.test(ua);
      const isTablet = /iPad|Android(?!.*Mobile)/i.test(ua);
      const isSmallScreen = width < CONFIG.MOBILE_MAX_WIDTH;
      const hasTouch = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
      
      const result = isMobileUA && isSmallScreen && hasTouch && !isTablet;
      
      console.log('[ORIENT] Mobile check:', {
        ua: isMobileUA,
        tablet: isTablet,
        width: width,
        touch: hasTouch,
        result: result ? 'üì± MOBILE' : 'üñ•Ô∏è DESKTOP'
      });
      
      return result;
    };

    // ===== PORTRAIT DETECTION (Try all methods) =====
    window.IsPortraitMode = function() {
      const w = window.innerWidth;
      const h = window.innerHeight;
      
      // ‚úÖ METHOD 1: Screen Orientation API (most reliable)
      if (window.screen?.orientation?.type) {
        const result = window.screen.orientation.type.includes('portrait');
        console.log('[ORIENT] screen.orientation:', window.screen.orientation.type, '‚Üí', result ? 'PORTRAIT' : 'LANDSCAPE');
        return result;
      }
      
      // ‚úÖ METHOD 2: window.orientation (iOS Safari)
      if (typeof window.orientation !== 'undefined') {
        const angle = window.orientation;
        const result = (angle === 0 || angle === 180);
        console.log('[ORIENT] window.orientation:', angle + '¬∞', '‚Üí', result ? 'PORTRAIT' : 'LANDSCAPE');
        return result;
      }
      
      // ‚úÖ METHOD 3: matchMedia
      if (window.matchMedia) {
        const result = window.matchMedia('(orientation: portrait)').matches;
        console.log('[ORIENT] matchMedia:', result ? 'PORTRAIT' : 'LANDSCAPE');
        return result;
      }
      
      // ‚úÖ METHOD 4: Dimensions (fallback)
      const result = h > w * CONFIG.PORTRAIT_THRESHOLD;
      console.log('[ORIENT] dimensions:', w + 'x' + h, '‚Üí', result ? 'PORTRAIT' : 'LANDSCAPE');
      return result;
    };

    // ===== MAIN CHECK FUNCTION =====
    function checkOrientation(immediate = false) {
      // Debounce rapid calls
      const now = Date.now();
      if (!immediate && now - state.lastCheck < 50) {
        return;
      }
      state.lastCheck = now;
      state.checkCount++;
      
      const mobile = window.IsMobileBrowser();
      const portrait = window.IsPortraitMode();
      const prompt = document.getElementById('rotation-prompt');
      const canvas = document.getElementById('unity-canvas');
      
      console.log(`%c[ORIENT] CHECK #${state.checkCount}`, 'color: #ff0', {
        mobile,
        portrait,
        size: `${window.innerWidth}x${window.innerHeight}`,
        promptVisible: state.promptVisible
      });
      
      // ===== DECISION =====
      const shouldShowPrompt = mobile && portrait;
      
      if (shouldShowPrompt !== state.promptVisible) {
        console.log('%c[ORIENT] üîÑ STATE CHANGE!', 'color: #f0f; font-weight: bold');
        
        if (shouldShowPrompt) {
          // ‚úÖ SHOW PROMPT
          if (prompt) {
            prompt.classList.add('show');
            console.log('[ORIENT] ‚úÖ PROMPT SHOWN');
          }
          state.promptVisible = true;
          
          // ‚úÖ Start continuous checking
          startContinuousCheck();
          
        } else {
          // ‚úÖ HIDE PROMPT
          if (prompt) {
            prompt.classList.remove('show');
            console.log('[ORIENT] ‚ùå PROMPT HIDDEN ‚Üí GAME VISIBLE');
          }
          state.promptVisible = false;
          
          // ‚úÖ Stop continuous checking
          stopContinuousCheck();
          
          // ‚úÖ Force canvas visibility
          if (canvas) {
            canvas.style.display = 'block';
            canvas.style.visibility = 'visible';
            canvas.style.opacity = '1';
            canvas.style.pointerEvents = 'auto';
          }
        }
      }
      
      // ‚úÖ Always ensure canvas is configured
      if (canvas && !state.promptVisible) {
        canvas.style.display = 'block';
        canvas.style.width = '100%';
        canvas.style.height = '100%';
      }
      
      state.mobile = mobile;
      state.portrait = portrait;
    }

    // ===== CONTINUOUS CHECKING (while portrait) =====
    function startContinuousCheck() {
      stopContinuousCheck();
      
      console.log('[ORIENT] üîÑ Starting continuous check (every 250ms)...');
      continuousCheckTimer = setInterval(() => {
        if (state.promptVisible) {
          checkOrientation(true);
        } else {
          stopContinuousCheck();
        }
      }, CONFIG.CONTINUOUS_CHECK_INTERVAL);
    }

    function stopContinuousCheck() {
      if (continuousCheckTimer) {
        clearInterval(continuousCheckTimer);
        continuousCheckTimer = null;
        console.log('[ORIENT] ‚è∏Ô∏è Stopped continuous check');
      }
    }

    // ===== DIMENSION STABILIZATION =====
    function checkWithStabilization() {
      clearTimeout(dimensionCheckTimer);
      
      // Check immediately
      checkOrientation(true);
      
      // Check again after dimensions stabilize
      dimensionCheckTimer = setTimeout(() => {
        checkOrientation(true);
      }, CONFIG.DIMENSION_STABILIZE_TIME);
    }

    // ===== EVENT LISTENERS =====
    
    // ‚úÖ Initial check
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => checkOrientation(true), 100);
      });
    } else {
      setTimeout(() => checkOrientation(true), 100);
    }

    // ‚úÖ Window resize (MOST RELIABLE on Android)
    window.addEventListener('resize', () => {
      console.log('[ORIENT] üìê Resize:', window.innerWidth + 'x' + window.innerHeight);
      checkWithStabilization();
    });

    // ‚úÖ Orientation change (iOS)
    window.addEventListener('orientationchange', () => {
      console.log('[ORIENT] üì± orientationchange event');
      setTimeout(() => checkWithStabilization(), CONFIG.CHECK_DELAY);
    });

    // ‚úÖ Screen orientation API
    if (window.screen?.orientation) {
      window.screen.orientation.addEventListener('change', () => {
        console.log('[ORIENT] üì± screen.orientation.change:', window.screen.orientation.type);
        setTimeout(() => checkWithStabilization(), CONFIG.CHECK_DELAY);
      });
    }

    // ‚úÖ matchMedia listeners
    if (window.matchMedia) {
      const portraitMQL = window.matchMedia('(orientation: portrait)');
      const landscapeMQL = window.matchMedia('(orientation: landscape)');
      
      const handler = (e) => {
        console.log('[ORIENT] üì± matchMedia changed:', e.media);
        checkWithStabilization();
      };
      
      if (portraitMQL.addEventListener) {
        portraitMQL.addEventListener('change', handler);
        landscapeMQL.addEventListener('change', handler);
      } else if (portraitMQL.addListener) {
        // Legacy browsers
        portraitMQL.addListener(handler);
        landscapeMQL.addListener(handler);
      }
    }

    // ‚úÖ Visibility change
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) {
        console.log('[ORIENT] üëÅÔ∏è Tab visible - rechecking');
        setTimeout(() => checkOrientation(true), 300);
      }
    });

    // ‚úÖ Page show (back button)
    window.addEventListener('pageshow', () => {
      console.log('[ORIENT] üîÑ Page show');
      setTimeout(() => checkOrientation(true), 300);
    });

    // ===== MANUAL CONTROLS =====
    
    // From Unity
    window.HideRotationPrompt = function() {
      const prompt = document.getElementById('rotation-prompt');
      if (prompt) {
        prompt.classList.remove('show');
        state.promptVisible = false;
        stopContinuousCheck();
        console.log('[ORIENT] üéÆ Force hide from Unity');
      }
    };

    // From user button
    window.skipRotationPrompt = function() {
      console.log('[ORIENT] ‚è≠Ô∏è User skipped prompt');
      window.HideRotationPrompt();
      
      // Force canvas visible
      const canvas = document.getElementById('unity-canvas');
      if (canvas) {
        canvas.style.display = 'block';
        canvas.style.visibility = 'visible';
        canvas.style.opacity = '1';
      }
    };

    console.log('[ORIENT] ‚úÖ v5.0 initialized with aggressive detection');
  })();
  </script>

  <!-- Tab Visibility -->
  <script>
    let isTabVisible = true;

    document.addEventListener('visibilitychange', function () {
      isTabVisible = !document.hidden;
      console.log('[TAB]', isTabVisible ? 'VISIBLE' : 'HIDDEN');

      if (window.unityInstance) {
        try {
          if (!isTabVisible) {
            window.unityInstance.SendMessage('GameManager', 'OnApplicationPause', '1');
          } else {
            window.unityInstance.SendMessage('GameManager', 'OnApplicationPause', '0');
          }
        } catch (e) {
          console.warn('[TAB] SendMessage failed:', e.message);
        }
      }
    });
  </script>

  <!-- Kulino Bridge -->
  <script>
    (function () {
      const LOG = (...a) => console.log('[KULINO-BRIDGE]', ...a);
      const queue = [];
      let unityReady = false;

      window.__kulino_unity_ready = function () {
        LOG('‚úÖ Unity ready');
        unityReady = true;
        while (queue.length) {
          const item = queue.shift();
          _sendToUnity(item.method, item.payload);
        }
        checkWallet();
      };

      function _sendToUnity(method, payload) {
        try {
          if (window.unityInstance?.SendMessage) {
            window.unityInstance.SendMessage('GameManager', method, payload);
          } else {
            queue.push({ method, payload });
          }
        } catch (e) {
          console.error('[KULINO-BRIDGE] Send error', e);
        }
      }

      function checkWallet() {
        const params = new URLSearchParams(window.location.search);
        const wallet = params.get('wallet');
        if (wallet) {
          LOG('‚úÖ Wallet:', wallet.substring(0, 8) + '...');
          notifyWallet(wallet);
        }
      }

      function notifyWallet(address, retry = 0) {
        if (!window.unityInstance?.SendMessage) {
          if (retry < 10) {
            setTimeout(() => notifyWallet(address, retry + 1), 500);
          }
          return;
        }
        try {
          window.unityInstance.SendMessage('GameManager', 'OnWalletConnected', address);
          LOG('‚úÖ Wallet sent to GameManager');
        } catch (e) {
          console.error('[KULINO-BRIDGE] Notify failed', e);
        }
      }

      LOG('‚úÖ Bridge loaded');
    })();
  </script>

  <!-- Unity Loader -->
  <script>
    var canvas = document.querySelector("#unity-canvas");
    var buildUrl = "Build";
    var loaderUrl = buildUrl + "/{{{ LOADER_FILENAME }}}";
    var config = {
      dataUrl: buildUrl + "/{{{ DATA_FILENAME }}}",
      frameworkUrl: buildUrl + "/{{{ FRAMEWORK_FILENAME }}}",
      codeUrl: buildUrl + "/{{{ CODE_FILENAME }}}",
      streamingAssetsUrl: "StreamingAssets",
      companyName: "{{{ COMPANY_NAME }}}",
      productName: "{{{ PRODUCT_NAME }}}",
      productVersion: "{{{ PRODUCT_VERSION }}}",
      showBanner: unityShowBanner,
      matchWebGLToCanvasSize: true,
      devicePixelRatio: 1
    };

    document.querySelector("#unity-loading-bar").style.display = "block";

    var script = document.createElement("script");
    script.src = loaderUrl;
    script.onload = () => {
      createUnityInstance(canvas, config, (progress) => {
        document.querySelector("#unity-progress-bar-full").style.width = 100 * progress + "%";
      }).then((unityInstance) => {
        document.querySelector("#unity-loading-bar").style.display = "none";
        window.unityInstance = unityInstance;

        if (typeof window.__kulino_unity_ready === 'function') {
          window.__kulino_unity_ready();
        }

        console.log('‚úÖ Unity loaded');
      }).catch((message) => {
        console.error('‚ùå Unity load failed', message);
        alert('Failed to load game. Please refresh.');
      });
    };
    document.body.appendChild(script);
  </script>
</body>
</html>