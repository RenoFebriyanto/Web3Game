<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>{{{ PRODUCT_NAME }}} - Kulino</title>
  <link rel="shortcut icon" href="TemplateData/favicon.ico" />
  <link rel="stylesheet" href="TemplateData/style.css" />
  
  <!-- Mobile Viewport -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  
  <!-- Landscape Enforcement -->
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-fullscreen" />
  
  <!-- ‚úÖ CSS UNTUK ROTATION PROMPT -->
<style>
  /* Rotation Prompt */
  #rotation-prompt {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.95);
    z-index: 9999;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 20px;
  }
  
  #rotation-prompt.show {
    display: flex !important;
  }
  
  .rotation-icon {
    font-size: 80px;
    margin-bottom: 20px;
    animation: rotate-icon 2s infinite;
  }
  
  @keyframes rotate-icon {
    0%, 100% { transform: rotate(0deg); }
    50% { transform: rotate(90deg); }
  }
  
  .rotation-text {
    font-size: 24px;
    font-weight: bold;
    color: #fff;
    margin-bottom: 10px;
  }
  
  .rotation-subtext {
    font-size: 16px;
    color: #aaa;
  }

  /* Canvas Full Screen */
  #unity-canvas {
    display: block;
    width: 100% !important;
    height: 100% !important;
    max-width: 100%;
    max-height: 100%;
  }
</style>

  <!-- Required Libraries -->
  <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
  <script src="https://unpkg.com/@solana/spl-token@latest/lib/index.iife.min.js"></script>
  <script src="https://unpkg.com/bs58@4.0.1/dist/index.min.js"></script>
  <script src="https://unpkg.com/buffer-layout@1.2.2/lib/layout-browser.js"></script>
  <script src="phantom-payment.js"></script>
</head>

<body>
  <!-- ‚úÖ ROTATION PROMPT OVERLAY (MOBILE ONLY) -->
  <div id="rotation-prompt">
    <div class="rotation-icon">üì±</div>
    <div class="rotation-text">Please rotate your device</div>
    <div class="rotation-subtext">This game works best in landscape mode</div>
  </div>

  <!-- Unity Container -->
  <div id="unity-container">
    <canvas id="unity-canvas" tabindex="-1"></canvas>
    <div id="unity-loading-bar" style="display:none">
      <div id="unity-logo"></div>
      <div id="unity-progress-bar-empty">
        <div id="unity-progress-bar-full"></div>
      </div>
    </div>
    <div id="unity-warning"></div>
  </div>

  <!-- Unity Show Banner -->
  <script>
  window.onerror = function(message, source, lineno, colno, error) {
    console.error('[GLOBAL-ERROR]', message, 'at', source, lineno + ':' + colno);
    
    var suppressedErrors = [
      'Module_main', 'callMain', 'doRun', 'run(', 'runCaller',
      'Module.run', 'abort(', 'ExitStatus'
    ];
    
    var shouldSuppress = suppressedErrors.some(function(err) {
      return message.includes(err) || (source && source.includes(err));
    });
    
    if (shouldSuppress) {
      console.warn('[GLOBAL-ERROR] Suppressed Unity error (tab switch/reload)');
      return true;
    }
    
    return false;
  };
  
  function unityShowBanner(msg, type) {
    try {
      var warningBanner = document.querySelector("#unity-warning");
      function updateBannerVisibility() {
        warningBanner.style.display = warningBanner.children.length ? "block" : "none";
      }
      var div = document.createElement("div");
      div.textContent = msg;
      div.style.padding = "8px";
      div.style.margin = "6px";
      if (type === "error") div.style.background = "rgba(200,0,0,0.9)";
      else if (type === "warning") div.style.background = "rgba(200,160,0,0.9)";
      else div.style.background = "rgba(0,0,0,0.6)";
      warningBanner.appendChild(div);
      if (type !== "error") {
        setTimeout(function() { 
          warningBanner.removeChild(div); 
          updateBannerVisibility(); 
        }, 5000);
      }
      updateBannerVisibility();
    } catch(e){ 
      console.warn('unityShowBanner error', e); 
    }
  }
  </script>

  <!-- Tab Visibility Handler -->
  <script>
  let isTabVisible = true;
  let unityPaused = false;
  
  document.addEventListener('visibilitychange', function() {
    isTabVisible = !document.hidden;
    console.log('[TAB]', isTabVisible ? 'VISIBLE' : 'HIDDEN');
    
    if (window.unityInstance) {
      try {
        if (!isTabVisible) {
          console.log('[TAB] Pausing Unity...');
          window.unityInstance.SendMessage('GameManager', 'OnApplicationPause', '1');
          unityPaused = true;
        } else {
          console.log('[TAB] Resuming Unity...');
          window.unityInstance.SendMessage('GameManager', 'OnApplicationPause', '0');
          unityPaused = false;
        }
      } catch(e) {
        console.warn('[TAB] SendMessage failed:', e.message);
      }
    }
  });
  
  window.addEventListener('focus', function() {
    console.log('[WINDOW] Focused');
    isTabVisible = true;
  });
  
  window.addEventListener('blur', function() {
    console.log('[WINDOW] Blurred');
    isTabVisible = false;
  });
  
  window.addEventListener('beforeunload', function() {
    console.log('[TAB] Page unloading - cleaning up');
    if (window.unityInstance) {
      try {
        window.unityInstance.Quit();
      } catch(e) {
        console.warn('[TAB] Quit failed:', e.message);
      }
    }
  });
  
  window.addEventListener('webglcontextlost', function(e) {
    console.error('[WEBGL] Context lost - preventing default');
    e.preventDefault();
  }, false);
  
  window.addEventListener('webglcontextrestored', function() {
    console.log('[WEBGL] Context restored');
  }, false);
  </script>

  <!-- ‚úÖ ORIENTATION DETECTION JAVASCRIPT -->
<script>
(function() {
  console.log('[ORIENT] Initializing...');

  // ‚úÖ CRITICAL: Define all functions BEFORE Unity loads
  window.IsMobileBrowser = function() {
    const ua = navigator.userAgent || navigator.vendor || window.opera;
    const isMobileUA = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(ua);
    const hasTouch = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
    const isSmallScreen = window.innerWidth < 1024;
    const isMobile = isMobileUA || (hasTouch && isSmallScreen);
    
    console.log('[ORIENT] Detection:', {
      userAgent: isMobileUA,
      touch: hasTouch,
      screenWidth: window.innerWidth,
      result: isMobile
    });
    
    return isMobile;
  };

  window.IsPortraitMode = function() {
    const portrait = window.innerHeight > window.innerWidth;
    console.log('[ORIENT] Check:', window.innerWidth, 'x', window.innerHeight, '=', portrait ? 'PORTRAIT' : 'LANDSCAPE');
    return portrait;
  };

  // ‚úÖ CRITICAL: Define NotifyOrientationToJS (required by Unity)
  window.NotifyOrientationToJS = function(isPortrait) {
    console.log('[ORIENT] Unity notified, portrait:', isPortrait);
    checkOrientation();
  };

  // ‚úÖ Check and update UI
  function checkOrientation() {
    const mobile = window.IsMobileBrowser();
    const portrait = window.IsPortraitMode();
    const prompt = document.getElementById('rotation-prompt');
    const canvas = document.getElementById('unity-canvas');
    
    console.log('[ORIENT] Mobile:', mobile, '| Portrait:', portrait);
    
    if (mobile && portrait) {
      if (prompt) prompt.classList.add('show');
      if (canvas) canvas.style.display = 'none';
      console.log('[ORIENT] ‚ö†Ô∏è PORTRAIT - Showing prompt');
    } else {
      if (prompt) prompt.classList.remove('show');
      if (canvas) {
        canvas.style.display = 'block';
        canvas.style.width = '100%';
        canvas.style.height = '100%';
      }
      console.log('[ORIENT] ‚úÖ LANDSCAPE - OK');
    }
  }

  // ‚úÖ Event listeners
  window.addEventListener('load', function() {
    console.log('[ORIENT] Page loaded');
    setTimeout(checkOrientation, 100);
  });

  let resizeTimer;
  window.addEventListener('resize', function() {
    console.log('[ORIENT] Window resized');
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(checkOrientation, 200);
  });

  window.addEventListener('orientationchange', function() {
    console.log('[ORIENT] Orientation changed');
    setTimeout(checkOrientation, 300);
  });

  console.log('[ORIENT] ‚úÖ System ready');
})();
</script>

  <!-- Kulino Bridge -->
  <script>
  (function(){
    const LOG = (...a) => console.log('[KULINO-BRIDGE]', ...a);

    const queue = [];
    let unityReady = false;

    window.__kulino_unity_ready = function(){
      LOG('‚úÖ Unity ready. Queue:', queue.length);
      unityReady = true;
      
      while(queue.length){
        const item = queue.shift();
        _sendToUnity(item.method, item.payload);
      }
      
      checkWallet();
    };

    function _sendToUnity(method, payload){
      try {
        if (window.unityInstance && typeof window.unityInstance.SendMessage === 'function') {
          LOG('üì§', method);
          window.unityInstance.SendMessage('GameManager', method, payload);
        } else {
          queue.push({ method, payload });
        }
      } catch(e){ 
        console.error('[KULINO-BRIDGE] Send error', e); 
      }
    }

    function sendResult(obj){
      const json = JSON.stringify(obj);
      if (!unityReady) { 
        queue.push({ method: 'OnClaimResult', payload: json }); 
      } else {
        _sendToUnity('OnClaimResult', json);
      }
    }

    function checkWallet() {
      const params = new URLSearchParams(window.location.search);
      const wallet = params.get('wallet');
      
      if (wallet) {
        LOG('‚úÖ Wallet found:', wallet.substring(0, 8) + '...');
        notifyWallet(wallet);
      }
    }

    function notifyWallet(address, retry = 0) {
      if (!window.unityInstance || typeof window.unityInstance.SendMessage !== 'function') {
        if (retry < 10) {
          setTimeout(() => notifyWallet(address, retry + 1), 500);
        }
        return;
      }
      
      try {
        window.unityInstance.SendMessage('GameManager', 'OnWalletConnected', address);
        LOG('‚úÖ Wallet sent to GameManager');
      } catch(e) {
        console.error('[KULINO-BRIDGE] Notify failed', e);
      }
    }

    window.requestClaimFromUnity = async function(messageJson) {
      LOG('üí∞ Claim requested');
      try {
        const provider = (window.solana && window.solana.isPhantom) ? window.solana :
                         (window.phantom && window.phantom.solana) ? window.phantom.solana : null;
        if (!provider) {
          sendResult({ success:false, error:'phantom_not_installed' });
          return;
        }

        let payload = (typeof messageJson === 'string') ? JSON.parse(messageJson) : messageJson;

        if (!provider.isConnected) {
          await provider.connect();
        }

        payload.address = provider.publicKey.toString();
        const canonical = {
          address: payload.address,
          gameId: payload.gameId,
          amount: payload.amount,
          nonce: payload.nonce,
          ts: payload.ts
        };
        const messageStr = JSON.stringify(canonical);

        const encoded = new TextEncoder().encode(messageStr);
        const signed = await provider.signMessage(encoded, 'utf8');
        const sig = bs58.encode(signed.signature);

        const resp = await fetch('http://localhost:3000/api/claim', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ 
            message: messageStr, 
            signature: sig, 
            publicKey: provider.publicKey.toString() 
          })
        });

        let data = await resp.json();
        sendResult(data);

      } catch(err) {
        console.error('[KULINO-BRIDGE] Error:', err);
        sendResult({ success:false, error: err.message || String(err) });
      }
    };

    LOG('‚úÖ Bridge loaded');
  })();
  </script>

  <!-- Unity Loader -->
  <script>
    var canvas = document.querySelector("#unity-canvas");
    
    canvas.addEventListener('webglcontextlost', function(e) {
      console.error('[CANVAS] WebGL context lost');
      e.preventDefault();
    }, false);
    
    canvas.addEventListener('webglcontextrestored', function() {
      console.log('[CANVAS] WebGL context restored');
    }, false);
    
    var buildUrl = "Build";
    var loaderUrl = buildUrl + "/{{{ LOADER_FILENAME }}}";
    var config = {
      dataUrl: buildUrl + "/{{{ DATA_FILENAME }}}",
      frameworkUrl: buildUrl + "/{{{ FRAMEWORK_FILENAME }}}",
      codeUrl: buildUrl + "/{{{ CODE_FILENAME }}}",
      streamingAssetsUrl: "StreamingAssets",
      companyName: "{{{ COMPANY_NAME }}}",
      productName: "{{{ PRODUCT_NAME }}}",
      productVersion: "{{{ PRODUCT_VERSION }}}",
      showBanner: unityShowBanner,
      matchWebGLToCanvasSize: true,
      devicePixelRatio: window.devicePixelRatio || 1,
      webglContextAttributes: {
        preserveDrawingBuffer: false,
        powerPreference: "high-performance"
      }
    };

    document.querySelector("#unity-loading-bar").style.display = "block";

    var script = document.createElement("script");
    script.src = loaderUrl;
    script.onload = () => {
      createUnityInstance(canvas, config, (progress) => {
        document.querySelector("#unity-progress-bar-full").style.width = 100 * progress + "%";
      }).then((unityInstance) => {
        document.querySelector("#unity-loading-bar").style.display = "none";
        window.unityInstance = unityInstance;
        
        window.addEventListener('error', function(e) {
          console.error('[UNITY-ERROR]', e.message);
          if (e.message.includes('Module_main') || 
              e.message.includes('callMain') ||
              e.message.includes('doRun')) {
            console.warn('[UNITY-ERROR] Suppressed Unity initialization error');
            e.preventDefault();
            return false;
          }
        });
        
        window.addEventListener('unhandledrejection', function(e) {
          console.error('[UNITY-PROMISE]', e.reason);
          if (e.reason && e.reason.toString().includes('WebGL')) {
            console.warn('[UNITY-PROMISE] Suppressed WebGL error');
            e.preventDefault();
          }
        });
        
        if (typeof window.__kulino_unity_ready === 'function') {
          window.__kulino_unity_ready();
        }
        
        console.log('‚úÖ Unity loaded');
      }).catch((message) => {
        console.error('‚ùå Unity load failed', message);
        
        var errorMsg = 'Failed to load game';
        if (message.includes('memory')) {
          errorMsg += ': Not enough memory';
        } else if (message.includes('WebGL')) {
          errorMsg += ': WebGL not supported';
        }
        
        alert(errorMsg + '. Please refresh the page.');
      });
    };
    script.onerror = (e) => {
      console.error('‚ùå Loader script failed', e);
      unityShowBanner('Failed to load Unity. Please check your connection.', 'error');
    };
    document.body.appendChild(script);
  </script>
</body>
</html>