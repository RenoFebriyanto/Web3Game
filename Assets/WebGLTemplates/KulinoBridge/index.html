<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>TestingWeb3 - Kulino</title>
    <link rel="shortcut icon" href="TemplateData/favicon.ico" />
    <link rel="stylesheet" href="TemplateData/style.css" />
    
    <!-- ‚úÖ EXISTING META TAG (KEPT) -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    
    <!-- ‚úÖ NEW: LANDSCAPE META TAGS (ADDED) -->
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-fullscreen" />
    <meta name="screen-orientation" content="landscape" />
    <meta name="x5-orientation" content="landscape" />
    <meta name="x5-fullscreen" content="true" />
    
    <style>
      /* ===== EXISTING STYLES (KEPT) ===== */
      html,body { height:100%; margin:0; background:#222; color:#fff; }
      #unity-container.unity-desktop { width:100%; height:100%; display:flex; align-items:center; justify-content:center; }
      #unity-loading-bar { position:absolute; top:20px; left:20px; right:20px; max-width:720px; }
      
      /* ‚úÖ NEW: LANDSCAPE ENFORCEMENT (ADDED) */
      @media screen and (orientation: portrait) {
        html {
          transform: rotate(-90deg);
          transform-origin: left top;
          width: 100vh;
          height: 100vw;
          overflow-x: hidden;
          position: absolute;
          top: 100%;
          left: 0;
        }
      }
      
      /* ‚úÖ NEW: ROTATION PROMPT OVERLAY (ADDED) */
      #rotation-prompt {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.95);
        z-index: 9999;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 20px;
      }
      
      #rotation-prompt.show {
        display: flex;
      }
      
      .rotation-icon {
        font-size: 80px;
        margin-bottom: 20px;
        animation: rotate-icon 2s infinite;
      }
      
      @keyframes rotate-icon {
        0%, 100% { transform: rotate(0deg); }
        50% { transform: rotate(90deg); }
      }
      
      .rotation-text {
        font-size: 24px;
        font-weight: bold;
        color: #fff;
        margin-bottom: 10px;
      }
      
      .rotation-subtext {
        font-size: 16px;
        color: #aaa;
      }
    </style>

    <!-- EXISTING LIBRARIES (KEPT) -->
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
    <script src="https://unpkg.com/@solana/spl-token@latest/lib/index.iife.min.js"></script>
    <script src="https://unpkg.com/bs58@4.0.1/dist/index.min.js"></script>
  </head>
  
  <body>
    <!-- ‚úÖ NEW: ROTATION PROMPT OVERLAY (ADDED) -->
    <div id="rotation-prompt">
      <div class="rotation-icon">üì±‚û°Ô∏èüñ•Ô∏è</div>
      <div class="rotation-text">Please rotate your device</div>
      <div class="rotation-subtext">This game works best in landscape mode</div>
    </div>

    <!-- EXISTING UNITY CONTAINER (KEPT) -->
    <div id="unity-container" class="unity-desktop">
      <canvas id="unity-canvas" width="1280" height="720" tabindex="-1"></canvas>
      <div id="unity-loading-bar" style="display:none">
        <div id="unity-logo"></div>
        <div id="unity-progress-bar-empty"><div id="unity-progress-bar-full"></div></div>
      </div>
      <div id="unity-warning"></div>
      <div id="unity-footer">
        <div id="unity-fullscreen-button"></div>
        <div id="unity-build-title">TestingWeb3</div>
      </div>
    </div>

    <!-- ===========================
         KULINO BRIDGE START
         =========================== -->

    <!-- EXISTING bs58 (KEPT) -->
    <script src="https://unpkg.com/bs58@4.0.1/dist/index.min.js"></script>

    <!-- EXISTING unityShowBanner (KEPT) -->
    <script>
    function unityShowBanner(msg, type) {
      try {
        var warningBanner = document.querySelector("#unity-warning");
        function updateBannerVisibility() {
          warningBanner.style.display = warningBanner.children.length ? "block" : "none";
        }
        var div = document.createElement("div");
        div.textContent = msg;
        div.style.padding = "8px";
        div.style.margin = "6px";
        if (type === "error") div.style.background = "rgba(200,0,0,0.9)";
        else if (type === "warning") div.style.background = "rgba(200,160,0,0.9)";
        else div.style.background = "rgba(0,0,0,0.6)";
        warningBanner.appendChild(div);
        if (type !== "error") {
          setTimeout(function() { warningBanner.removeChild(div); updateBannerVisibility(); }, 5000);
        } else {
          // keep errors visible
        }
        updateBannerVisibility();
      } catch(e){ console.warn('unityShowBanner error', e); }
    }
    </script>

    <!-- ‚úÖ NEW: ORIENTATION DETECTION (ADDED) -->
    <script>
    // Detect mobile & orientation
    function isMobileBrowser() {
      return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }
    
    function isPortraitMode() {
      return window.innerHeight > window.innerWidth;
    }
    
    function checkOrientation() {
      var prompt = document.getElementById('rotation-prompt');
      var canvas = document.getElementById('unity-canvas');
      
      if (isMobileBrowser() && isPortraitMode()) {
        prompt.classList.add('show');
        if (canvas) canvas.style.display = 'none';
      } else {
        prompt.classList.remove('show');
        if (canvas) canvas.style.display = 'block';
      }
    }
    
    // Check on load and resize
    window.addEventListener('load', checkOrientation);
    window.addEventListener('resize', checkOrientation);
    window.addEventListener('orientationchange', checkOrientation);
    
    // Make functions available to Unity
    window.IsMobileBrowser = isMobileBrowser;
    window.IsPortraitMode = isPortraitMode;
    window.ShowRotationPromptJS = function() {
      document.getElementById('rotation-prompt').classList.add('show');
    };
    window.HideRotationPromptJS = function() {
      document.getElementById('rotation-prompt').classList.remove('show');
    };
    
    console.log('[ORIENTATION] Detection loaded');
    </script>

    <!-- EXISTING KULINO BRIDGE (KEPT - NO CHANGES) -->
    <script>
    (function(){
      const LOGPREF = '[KULINO-BRIDGE]';
      function dlog(...a){ console.log(LOGPREF, ...a); }

      const sendQueue = [];
      let unityReady = false;

      window.__kulino_unity_ready = function(){
        dlog('Unity reported ready. flushing queue len=', sendQueue.length);
        unityReady = true;
        while(sendQueue.length){
          const item = sendQueue.shift();
          _doSendToUnity(item.method, item.payload);
        }
      };

      function _doSendToUnity(methodName, payloadJson){
        try {
          if (window.unityInstance && typeof window.unityInstance.SendMessage === 'function') {
            dlog('SendMessage ->', methodName, payloadJson);
            window.unityInstance.SendMessage('GameManager', methodName, payloadJson);
          } else {
            console.warn(LOGPREF, 'unityInstance.SendMessage not available, queueing');
            sendQueue.push({ method: methodName, payload: payloadJson });
          }
        } catch(e){ console.error(LOGPREF, 'SendMessage exception', e); }
      }

      function sendToUnity(obj){
        const js = JSON.stringify(obj);
        if (!unityReady) { sendQueue.push({ method: 'OnClaimResult', payload: js }); dlog('queued OnClaimResult'); }
        else _doSendToUnity('OnClaimResult', js);
      }

      window.requestClaimFromUnity = async function(messageJson) {
        dlog('requestClaimFromUnity called with:', messageJson);
        try {
          const provider = (window.solana && window.solana.isPhantom) ? window.solana :
                           (window.phantom && window.phantom.solana && window.phantom.solana.isPhantom) ? window.phantom.solana : null;
          if (!provider) {
            dlog('phantom not found');
            sendToUnity({ success:false, error:'phantom_not_installed' });
            return;
          }

          let payloadObj = (typeof messageJson === 'string') ? JSON.parse(messageJson) : messageJson;

          if (!provider.isConnected) {
            dlog('connecting to phantom...');
            await provider.connect();
            dlog('connected, pk=', provider.publicKey?.toString?.());
          }

          payloadObj.address = provider.publicKey.toString();
          const canonical = {
            address: payloadObj.address,
            gameId: payloadObj.gameId,
            amount: payloadObj.amount,
            nonce: payloadObj.nonce,
            ts: payloadObj.ts
          };
          const messageStr = JSON.stringify(canonical);
          dlog('message to sign:', messageStr);

          const encoded = new TextEncoder().encode(messageStr);
          dlog('calling provider.signMessage(...)');
          const signed = await provider.signMessage(encoded, 'utf8');
          dlog('signMessage returned', signed);

          if (typeof bs58 === 'undefined' && typeof window.bs58 === 'undefined') {
            dlog('bs58 missing');
            sendToUnity({ success:false, error:'bs58_lib_missing' });
            return;
          }
          const sig = (typeof bs58 !== 'undefined') ? bs58.encode(signed.signature) : window.bs58.encode(signed.signature);

          dlog('POSTing to server /api/claim');
          const resp = await fetch('http://localhost:3000/api/claim', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ message: messageStr, signature: sig, publicKey: provider.publicKey.toString() })
          });

          dlog('server status', resp.status);
          let data;
          try { data = await resp.json(); }
          catch(e){
            const text = await resp.text().catch(()=>'<no-text>');
            dlog('server returned non-json:', text);
            sendToUnity({ success:false, error:'invalid_server_response', raw: text });
            return;
          }
          dlog('server json', data);
          sendToUnity(data);

        } catch(err) {
          console.error(LOGPREF, 'requestClaimFromUnity error', err);
          sendToUnity({ success:false, error: err.message || String(err) });
        }
      };

      window.testClaimFromConsole = async function(){
        const payload = { gameId:'unity-demo', amount:1, nonce: crypto.randomUUID(), ts: Date.now() };
        await window.requestClaimFromUnity(JSON.stringify(payload));
      };

      window.__kulino_bridge_info = function(){ return { unityReady, queueLen: sendQueue.length, hasProvider: !!(window.solana && window.solana.isPhantom) }; };

      dlog('Kulino bridge loaded.');
    })();
    </script>

    <!-- EXISTING RequestClaim wrapper (KEPT) -->
    <script>
    function RequestClaim(message) {
      if (window.requestClaimFromUnity && typeof window.requestClaimFromUnity === 'function') {
        try {
          window.requestClaimFromUnity(message);
        } catch (e) {
          console.error('[RequestClaim wrapper] error', e);
        }
      } else {
        console.error('[RequestClaim wrapper] requestClaimFromUnity missing');
        if (window.unityInstance && typeof window.unityInstance.SendMessage === 'function') {
          const err = JSON.stringify({ success:false, error:'requestClaimFromUnity_missing' });
          window.unityInstance.SendMessage('GameManager','OnClaimResult', err);
        }
      }
    }
    </script>

    <!-- ===========================
         UNITY LOADER (KEPT - NO CHANGES)
         =========================== -->
    <script>
      var canvas = document.querySelector("#unity-canvas");
      var buildUrl = "Build";
      var loaderUrl = buildUrl + "/WebUnity.loader.js";
      var config = {
        dataUrl: buildUrl + "/WebUnity.data",
        frameworkUrl: buildUrl + "/WebUnity.framework.js",
        codeUrl: buildUrl + "/WebUnity.wasm",
        streamingAssetsUrl: "StreamingAssets",
        companyName: "Kulino",
        productName: "TestingWeb3",
        productVersion: "1.0",
        showBanner: unityShowBanner,
        matchWebGLToCanvasSize: false,
        devicePixelRatio: 1
      };

      document.querySelector("#unity-loading-bar").style.display = "block";

      var script = document.createElement("script");
      script.src = loaderUrl;
      script.onload = () => {
        createUnityInstance(canvas, config, (progress) => {
          document.querySelector("#unity-progress-bar-full").style.width = 100 * progress + "%";
        }).then((unityInstance) => {
          document.querySelector("#unity-loading-bar").style.display = "none";
          window.unityInstance = unityInstance;
          
          // EXISTING: tell bridge unity is ready
          if (typeof window.__kulino_unity_ready === 'function') window.__kulino_unity_ready();
          
          // ‚úÖ NEW: Final orientation check (ADDED)
          checkOrientation();
        }).catch((message) => {
          console.error('createUnityInstance failed', message);
          alert('Unity failed to load: ' + message);
        });
      };
      script.onerror = (e) => {
        console.error('Failed to load loader script:', loaderUrl, e);
        unityShowBanner('Failed to load Unity loader: ' + loaderUrl, 'error');
      };
      document.body.appendChild(script);
    </script>
  </body>
</html>